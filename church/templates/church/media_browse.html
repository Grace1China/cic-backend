{% load static i18n %}
{% load cust_filters %}
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <title>CKEditor | {% trans "Select an image to embed" %}</title>
        <link rel="stylesheet" href="{% static "church/css/dialog.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "admin/simpleui-x/elementui/theme-chalk/index.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "church/css/ossstyle.css" %}" type="text/css" />
        <!-- We only want the thunbnails to display when javascript is disabled -->
        <script type="text/javascript">
            document.write('<style>.noscript { display: none; }</style>');
        </script>
        <style type="text/css">
            a.thumb { text-align: center; display: block; float: left; width: 75px; height: 75px; word-wrap: break-word; line-height: 1.2em; overflow: hidden; }
            a.thumb img { display: inline-block; }
            span.filename { color: #666; font-size: 0.95em; }

            #page{
                height:100%;
            }
            #gallery { min-width: 880px; }
            #search {
                display:flex;
                
            }
            .image_check{
                width: 100%;
            }
            .mediacard{
                width:128px;
                min-width:128px;
            }


            .thumbimg {
                width: 100%;
                height: 100px;
                display: block;
            }
            .el-checkbox.is-bordered{
                height:auto;
                padding:0;
            }
            .el-checkbox__inner{
                position:absolute;
                left: -5px;
                bottom: 0px;
            }
            .el-checkbox__label{
                padding:0;
            }
            .imagetitle{
                width:128px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                margin-top:10px;
                position: absolute;
                bottom: 0;
                left: 0;
            }
            .toolbar {
                display: inline-flex;
                width: 100%;
                justify-content: space-between;
                margin: 15 0 0;
            }
            .el-icon-upload{
                line-height:unset;
            }
            .upload{
                height:94%;
                position:relative;
                overflow:scroll;
            }
            .el-upload--picture-card{
                display: inline-flex;
                justify-content: center;
                width:100%;
                height:100%;
                position:absolute;
                left:0;
            }
            .el-upload-list{
                z-index:40;
                position:absolute;
                left:0;
                width:100%;
            }
            .el-upload-dragger{
                margin: auto;
                display: flex;
                justify-content: center;
                align-items: center;
                background: none;
                border: none;
            }
            .extra-bar{
                position: absolute;
                width: 100%;
                height: 100%;
                left: 0;
                top: 0;
                cursor: default;
                text-align: center;
                color: #fff;
                opacity: 0;
                font-size: 20px;
                background-color: rgba(0,0,0,.5);
                transition: opacity .3s;
            }
            .hover .extra-bar{
                opacity: 1;
            }
            .el-checkbox__inner{
                left:0 !important;
            }
            .cktitle span{
                line-height : 1em;
            }

            .image-preview{
                width:600px !important;
                max-height:560px;
                overflow-y: scroll;
            }
            .el-tabs--border-card{
                border:none;
            }
            .el-tabs--border-card>.el-tabs__header {
                border:none;
            }
            .el-upload .el-upload--picture-card{
            
            }

            
            
        </style>
    </head>
    <body>
        <el-container id="page" style="visibility:hidden" ref="vuepage">
            <el-header>
                <div class="toolbar">
                    <el-select 
                        v-model="curdir" 
                        filterable placeholder="请选择分组"
                        @change="onSeriesChange($event)"
                    >
                        {% for key,value in series.items %}
                            <el-option
                                key="{{ key }}"
                                label="{{ value }}-{{key}}"
                                value="{{ key }}">
                            </el-option>
                        {% endfor %}
                    </el-select>
                
                    <el-input placeholder="请输入查找内容" v-model="searchkey" :style="{width: '30%'}" class="input-with-select" @keyup.enter.native="showFiles(activeTab,curdir,1,{'search':searchkey})">
                        <el-button slot="append" icon="el-icon-search" @click="showFiles(activeTab,curdir,1,{'search':searchkey})"></el-button>
                    </el-input>
                   
                    <el-button-group>
                        <el-pagination
                            background
                            layout="prev, pager, next"
                            :page-size="18"	
                            :total="totalmedia"
                            @current-change="pageChange"
                        >
                        </el-pagination>
                    </el-button-group>
                    <el-button v-if="!filePrepared"  type="primary" @click="goTab('upload')"><i class="el-icon-upload"></i>去上传页</el-button>
                    <el-button v-if="filePrepared"  type="success" @click.stop.prevent="submitUpload"><i class="el-icon-upload"></i>
                                执行上传
                    </el-button>
                </div>
            </el-header>
            <el-main id="gallery">
                <el-tabs v-model="activeTab" :tab-position="'left'" v-loading="loading" type="border-card" @tab-click="handleClick">
                    <el-tab-pane v-if="isShow('images')" label="图片" name="images">
                        <el-checkbox-group  v-if="activeTab == 'images'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg  mediadata"
                                                typ='images'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('videos')" label="影片" name="videos">
                        <el-checkbox-group v-if="activeTab == 'videos'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div :span="4" v-for="jj in 6" :key="jj">
                                    <el-card :body-style="{ padding: '0px' , position: 'relative' , width: '100%'}"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            v-loading="theImage(ii,jj).video_status!=3"
                                            :label=`${ii}-${jj}`
                                        >
                                            <div class="thumbimg"
                                            >
                                                <img 
                                                    :src=`${theImage(ii,jj).video_status==3?(theImage(ii,jj).video_tcinfo||{}).image3+'?x-oss-process=style/wh124':theImage(ii,jj).thumb}` 
                                                    :data-src=`${theImage(ii,jj).video_status==3?(theImage(ii,jj).video_tcinfo||{}).sd:theImage(ii,jj).src}`
                                                    typ="videos"
                                                    class="mediadata"
                                                />
                                            </div>
                                            
                                            <hovercard>
                                                <!-- 1、上传成功 状态为1。后显示一个cover就好。 -->
                                                <!-- 2、转码开始 状态为2。并且有转码中。。。的提示 -->
                                                <!-- 2、转码开始 状态为3。显示一个比较好图 -->
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                        <span
                                            :style="{ 'fontSize':'0.75rem' }"
                                            :title="[[ theImage(ii,jj).visible_filename  ]]"
                                        >
                                            [[ theImage(ii,jj).visible_filename | shortname]]
                                        </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('audios')" label="音乐" name="audios">
                        <el-checkbox-group v-if="activeTab == 'audios'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='audios'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('pdfs')" label="文档" name="pdfs">
                        <el-checkbox-group  v-if="activeTab == 'pdfs'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <!--上面这个label是el-checkbox-group的v-model的值。它也是唯一的。可以用来反查images里的object-->

                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='pdfs'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('tuwen')" label="图文" name="tuwen">
                        <el-checkbox-group  v-if="activeTab == 'tuwen'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <!--上面这个label是el-checkbox-group的v-model的值。它也是唯一的。可以用来反查images里的object-->

                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='tuwen'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shorttitle ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('content')" label="内容" name="content">
                        <el-checkbox-group  v-if="activeTab == 'content'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <!--上面这个label是el-checkbox-group的v-model的值。它也是唯一的。可以用来反查images里的object-->

                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='content'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shorttitle ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('contentcolumn')" label="内容专栏" name="contentcolumn">
                        <el-checkbox-group  v-if="activeTab == 'contentcolumn'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <!--上面这个label是el-checkbox-group的v-model的值。它也是唯一的。可以用来反查images里的object-->

                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='contentcolumn'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview(theImage(ii,jj))"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shorttitle ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane label="上传" name="upload">
                        <el-upload
                            class="upload"
                            ref="upload"
                            :with-credentials="true"
                            action=""
                            list-type="picture"
                            :auto-upload='false'
                            :before-upload="onbeforeUpload"
                            :on-progress="onprogress"
                            :on-change="onchange"
                            :on-error="onerror"
                            :on-success="onsuccess"
                            :on-remove="onremove"
                            :on-preview="handlePictureCardPreview"
                            :on-exceed="onexceed"
                            :show-file-list="true"
                            :http-request="diyUpload"
                            :limit="10"
                            multiple
                            drag
                        >
                            <i class="el-icon-upload"></i>
                        </el-upload> 
                        
                        <el-alert 
                            :title="errorMsg"
                            type="error"
                            :closable="false"
                            :style="{ display: errorDisplay }"
                        >
                        </el-alert>
                        
                    </el-tab-pane>
                </el-tabs>
                <el-dialog :visible.sync="dialogVisible" size="tiny" id="preview_dlg" @close="(this.document.querySelector('#preview_dlg video')|| this.document.createElement('video')).pause()">
                    <video v-if="dialogImageUrl.match('(.mp4$)')" :src="dialogImageUrl" controls width="100%">
                    <img v-if="dialogImageUrl.match('(.jpg$)|(.png$)|(.gif$)|(.ico$)')" width="100%" :src="dialogImageUrl" alt="">
                    <span></span>
                </el-dialog>
                
            </el-main>
            <el-footer v-if="isFromCtrl()">
                <el-button type="primary" @click.native='winClose'>取消</el-button>
                <el-button type="primary" @click=mediaReturn('ok')>确定返回结果</el-button>
            </el-footer>
            <el-footer v-if="isFrom_ckeditor_browse()">
                <el-button type="primary" @click=mediaEmbed()>嵌入</el-button>
            </el-footer>
        </el-container>

        <script type="text/javascript" src="{% static "church/js/vue.js" %}"></script>
        <script type="text/javascript" src="{% static "admin/simpleui-x/elementui/index.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/es6-promise.auto.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/vuex.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/store.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/axios.min.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/qrcode.min.js" %}"></script>
        <script src="http://gosspublic.alicdn.com/aliyun-oss-sdk-6.11.2.min.js"></script>
        <script>
            window.onload=function setupVue(){
                Vue.config.delimiters = ["[[", "]]"];
                Vue.component('hovercard', {
                    //props: ['value'],
                
                    data: function () {
                        return {
                            hover: false,
                        }
                    },
                    template: `
                        <div
                            @mouseover="hover = true"
                            @mouseleave="hover = false"
                            :class="{hover:hover}"
                            :style="{width: '100%', minWidth: '124px'}"
                        >
                            <slot/>
                        </div>
                    `
                })

                Vue.component('hoveralter', {
                    //props: ['value'],
                
                    data: function () {
                        return {
                            hover1: false,
                        }
                    },
                    template: `
                        <div
                            @mouseover="hover1 = true"
                            @mouseleave="hover1 = false"
                            :style="{width: '100%', minWidth: '124px'}"
                        >
                            <div v-show="hover1" style="">
                                <slot name="full"></slot>
                            </div>
                            <div v-show="!hover1">
                                <slot></slot>
                            </div>
                        </div>
                    `
                })
                var app = new Vue({
                    el: '#page',
                    data () {
                        return {
                            church:'{{ churchcode }}',
                            curdir: 'default',
                            activeTab: '{{ type }}',
                            dialogImageUrl: '',
                            dialogVisible: false,
                            errorDisplay:'none',
                            errorMsg:'',
                            filePrepared:false,
                            progressPercent:0,
                            fileArr:[],
                            page:{
                                'images':1,
                                'videos':1,
                                'audios':1,
                                'pdfs':1,
                                'content':1,
                            },
                            loading:false,
                            ALIOSS_DESTINATIONS:JSON.parse(`{{ ALIOSS_DESTINATIONS|safe }}`),
                            checkedImages:[],
                            checkedImages1:[],
                            searchkey:''

                        }
                    },
                    computed: {
                        count() {
                            return store.state.count
                        },
                        images(){
                            return store.state.images||[]
                        },
                        totalmedia(){
                            return store.state.totalmedia||0
                        },
                    },
                    store,
                    created:function(){
                        typ = this.getQueryVariable('type')
                        if((typ||'') == ''){
                            return
                        }
                        if (typ == 'links'){
                            this.showFiles('content',this.curdir,1)
                        }else{
                            this.showFiles(typ,this.curdir,1)
                        }
                    },
                    mounted: function (){
                        //this.showImages(this.curdir)
                        this.$refs.vuepage.$el.style.visibility = 'visible'
                        console.log(this.$refs.vuepage.$el.style.visibility)
                        
                    },
                    filters: {
                        shortname: function (value) {
                            if (!value) return ''
                            value = value.toString()
                            fn_arr = value.split('.')   //["", "mp4"]
                            
                            return (fn_arr[0].length > 10) ? `${fn_arr[0].substring(0,10)}...${fn_arr[1]}` : value
                        },
                        shorttitle: function (value) {
                            if (!value) return ''
                            value = value.toString()
                            //fn_arr = value.split('.')   //["", "mp4"]
                            
                            return (value.length > 12) ? `${value.substring(0,12)}...` : value
                        }
                    },
                    methods:{
                        hasTransCodeFile(file){
                            
                        },
                        checkij(value,ev){
                            console.log(`${value}-${ev}`)
                        },

                      

                        mediaReturn(o){
                            console.log('-----mediaReturn-----------')
                            console.log(this.images)
                            
                            from = this.getQueryVariable('from')
                            if(from=='vcomponent'){
                                var objs = []
                                for(var i = 0 ; i <= this.checkedImages.length-1; i++){
                                    arr = this.checkedImages[i].split('-')
                                    index = parseInt((arr[0]-1))*6+parseInt(arr[1]-1)
                                    objs.push(this.images[index])
                                }
                                console.log(`objs:${objs}`)
                                store.dispatch('addParts',{'linkjsons':objs,'compid':this.getQueryVariable('vcompid')})
                                window.opener.window.formVue.loadForm()
                                window.close()
                                return
                            }else{
                                arr = this.checkedImages[0].split('-')
                                index = parseInt((arr[0]-1))*6+parseInt(arr[1]-1)
                                o = this.images[index]
                                window.opener.window.formVue.setRo({ "from":`${from}`, "obj":o })
                                window.close()
                            }
                        },
                        mediaEmbed(){
                            console.log('-----mediaReturn-----------')
                            console.log(this.images)
                            arr = this.checkedImages[0].split('-')
                            index = parseInt((arr[0]-1))*6+parseInt(arr[1]-1)
                            //from = this.getQueryVariable('from')
                            o = this.images[index]
                            console.log(o)
                            funcNum = this.getQueryVariable('CKEditorFuncNum')
                            window.opener.CKEDITOR.tools.callFunction(funcNum, `${o.src}?x-oss-process=style/w730`);
                            window.close();
                        },
                        winClose(){
                            window.close()
                        },
                        getQueryVariable(variable){
                            var query = window.location.search.substring(1);
                            var vars = query.split("&");
                            for (var i=0;i<vars.length;i++) {
                                    var pair = vars[i].split("=");
                                    if(pair[0] == variable){return pair[1];}
                            }
                            return(false);
                        },
                    
                        isShow:function(typ='images'){
                            if (this.getQueryVariable('from')=='ckeditor' || this.getQueryVariable('from')=='admin' ){
                                return true
                            }else{
                                if(this.getQueryVariable('type') == 'links' && ['contentcolumn','content'].includes(typ)){
                                    return true
                                }else{
                                    return this.getQueryVariable('type') == typ
                                }
                            }
                        },   
                        isFromCtrl:function(){
                            console.log(this.getQueryVariable('from'))
                            if (this.getQueryVariable('from').indexOf('admin')>=0 || this.getQueryVariable('from').indexOf('ckeditor')>=0){
                                return false
                            }else{
                                return true
                            }
                        },     
                        isFrom_ckeditor_browse:function(){
                            console.log(this.getQueryVariable('from'))
                            if (this.getQueryVariable('from').indexOf('ckeditor_browse')>=0){
                                return true
                            }else{
                                return false
                            }
                        },            
                        theImage(i,j){
                            return (store.state.images||[])[(i-1)*6 + j-1]||{}
                        },
                        pageChange:function(page){
                            console.log(`--------pageChange(${page})----------------`)
                            this.showFiles(this.activeTab,this.curdir,page,{'search':this.searchkey})
                        },
                        next:function(){
                            //当没有18个图片的时候，说明就结束了
                            console.log('------next------')
                            this.page[this.activeTab] = (++this.page[this.activeTab] >=1 ? this.page[this.activeTab] : 1)
                            this.showFiles(this.activeTab,this.curdir,this.page[this.activeTab])
                        },
                        prev:function(){
                            this.page[this.activeTab] = (--this.page[this.activeTab] >=1 ? this.page[this.activeTab] : 1)
                            this.showFiles(this.activeTab,this.curdir,this.page[this.activeTab])
                        },
                        goTab(page){
                            this.activeTab = page
                        },
                        onSeriesChange:function(sereis){
                            if (sereis == 'upload') {return}
                            this.showFiles(this.activeTab,sereis,this.page[this.activeTab])
                        },
                        showFiles:function(type,series,page,extra){
                            /*
                            page 是从1开始的。有delfilekey，删除的文件key,在删除后，从新查找的逻辑
                            */
                            //delfilekey=undefined,searchkey=undefined
                            extra = extra||{}
                            vm = this
                            vm.loading = true
                            store.dispatch('getImages',{'type':type,'series':series,'page':page,'delfilekey':extra.delete,'searchkey':extra.search}).then(function(){
                                vm.$forceUpdate()
                                vm.loading = false
                            })
                        },
                        handleClick(tab, event) {
                            console.log(tab, event)
                            console.log(`-----------this.activeTab -------${this.activeTab}----`)
                    
                            this.loading = true
                            this.activeTab = tab.name
                            if (tab.name == 'upload'){
                                this.loading = false
                            }else{
                                this.showFiles(tab.name,this.curdir,this.page.image)
                            }
                            this.checkedImages = []
                        },
                        onbeforeUpload(file){
                            console.log('--------onbeforeUpload----------')
                            console.log(file)
                        },
                        onprogress(e, rawFile,fileList){
                
                            this.fileArr = fileList
                            this.fileArr.forEach(item=>{
                                if (item.percentage == 100) {

                                } else {
                                    item.progressFlag = true
                                    item.progressPercent = Math.abs(item.percentage.toFixed(0));
                                }
                            })
                        },
                        getTyp(filetype,name){
                            if(filetype != ''){
                                if(filetype.match('image/')){
                                    return 'images'
                                }
                                if(filetype.match('video/')){
                                    return 'videos'
                                }
                                if(filetype.match('audio/')){
                                    return 'audios'
                                }
                                if(filetype.match('pdf/')){
                                    return 'pdfs'
                                }
                            }else if (name != ''){
                                if (name.includes('.VOB') || name.includes('.vob')){
                                    return 'videos' 
                                }
                            }
                            return 'destination'
                        },
                        onchange(e,fileList){
                            console.log('-------onchange---------')
                            console.log(e)
                            console.log(fileList)

                            this.errorDisplay = 'none'
                            this.errorMsg=''

                            if(!e.raw.type.match('image/')){
                                if(e.raw.type.match('video/')){
                                    e.url="/static/church/img/vidoe.jpg"
                                } else if(e.raw.type.match('audio/')){
                                    e.url="/static/church/img/audio.jpg"
                                } else{
                                    e.url="/static/church/img/document.jpg"   
                                }
                            }
                            this.filePrepared = false
                            
                            fileList.forEach((item,index)=>{
                                allOk = true
                                if(item.status != 'ready'){
                                    allOk = false
                                }
                                this.filePrepared = allOk
                            })
                            if (fileList.length <= 0){
                                this.filePrepared = false
                            }
                            //"success" "ready" "uploading" "fail"
                        },
                        onerror(e,f){
                            console.log('-------onerror---------')
                            console.log(e)
                            console.log(f)
                        },
                        onsuccess(e,f,fileList){
                            console.log('-------onsuccess---------')
                            console.log(e)
                            console.log(f)
                            this.fileArr = fileList
                            this.fileArr.forEach((item,index)=>{
                                item.progressFlag = false
                                if(item.status == 'success'){
                                    item.successFlag = true
                                }else{
                                    item.successFlag = false
                                }
                            })
                        },
                        onremove(e,f){
                            console.log('-------onremove---------')
                            console.log(e)
                            console.log(f)
                            
                            if (f.length <= 0){
                                this.filePrepared = false
                            }
                            //this.fileArr.splice(f,1)
                        },
                        removeFile(item,index){
                            this.fileArr.splice(f,index)
                        },
                        onpreview(e,f){
                            console.log('-------onpreview---------')
                            console.log(e)
                            console.log(f)
                        },
                        onexceed(e,f){
                            console.log('-------onexceed---------')
                            console.log(e)
                            console.log(f)
                            if((e||[]).length >10){
                                this.errorDisplay = 'block'
                                this.errorMsg = `最多只能一次加入10个文件，现在有${e.length}请重新选择。`
                            }else{
                                this.errorDisplay = 'none'
                                this.errorMsg=''
                            }
                        },
                        submitUpload() {
                            //console.log(file)
                            
                            //return true
                            console.log('--------submitUpload---------------')
                            this.$refs.upload.submit();
                        },
                        removeKey(key){
                            console.log(`-----need to delete the bucket file and db record---of--${key}--`)
                            this.showFiles(this.activeTab,this.curdir,1,{'delete':key})
                        },
                        handlePictureCardPreview(file) {
                            /*is_image: false
                            key: "L3/default/be608047-8da4-eacb-08ba-7e263edb1ae9"
                            src: "https://api.bicf.org/mediabase/L3/default/be608047-8da4-eacb-08ba-7e263edb1ae9"
                            thumb: "https://api.bicf.org/mediabase/L3/default/be608047-8da4-eacb-08ba-7e263edb1ae9?x-oss-process=style/wh100_auto"
                            typ: "images"
                            visible_filename: "ckeditorpasted_2020/7/5_31a794ef-6ee7-3abe-d4f5-bb9155813911"
                            {'oname':theImage(ii,jj).visible_filename,'url':theImage(ii,jj).src,'qrcode':theImage(ii,jj).src_qrcode},'typ':*/
                            console.log('------------handlePictureCardPreview---------------')
                            console.log(file)
                            
                            if (file.typ=='images'){//((file||{}).oname||'').match('(.jpg$)|(.png$)|(.gif$)|(.ico$)')
                                this.$alert(`<span>${file.visible_filename}</span><img style="width:100%;height:auto;" src="${file.src}">`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview"
                                });
                                return
                            } else if (file.typ=='videos'){//((file||{}).oname||'').match('(.mp4$)')
                                this.$alert(`<span>${file.visible_filename}</span><video id="media-preview" style="width:100%;height:auto;" controls src="${file.video_tcinfo.sd}">`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview",
                                    beforeClose:(action,instance,done)=>{
                                        //console.log(instance)
                                        (instance.$el.querySelector('video#media-preview')||this.document.createElement('video')).pause()
                                        done()
                                    }
                                });
                                return
                            }else if(file.typ=='audios'){//((file||{}).oname||'').match('(.mp3$)|(.wav$)')
                                this.$alert(`<div style="display:flex;flex-direction:column;"><span>${file.visible_filename}</span><video controls="" autoplay="" id="media-preview" name="media"><source src="${file.src}" type="audio/mpeg"></video></div>`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview",
                                    beforeClose:(action,instance,done)=>{
                                        //console.log(instance)
                                        (instance.$el.querySelector('video#media-preview')||this.document.createElement('audio')).pause()
                                        done()
                                    }
                                });
                            }else if(file.typ=='pdfs'){//((file||{}).oname||'').match('(.pdf$)')
                                this.$alert(`<div style="display:flex;flex-direction:column;"><div style="display: flex;flex-direction: row;align-items: center;font-size: 1rem;justify-content: space-evenly;"><span>${file.visible_filename}</span><a href="${file.url}"><div id="qrcode"></div></a></div><iframe id="media-preview" name="media" src="${file.url}" ></iframe></div>`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview",
                                    beforeClose:(action,instance,done)=>{
                                        //console.log(instance)
                                        done()
                                    }
                                });
                            }else if(file.typ=='content'){//((file||{}).oname||'').match('(.pdf$)')
                                this.$alert(`<div style="display:flex;flex-direction:column;"><div style="display: flex;flex-direction: row;align-items: center;font-size: 1rem;justify-content: space-evenly;height:1rem;"><span>${file.visible_filename}</span><a href="${file.src}"><div id="qrcode"></div></a></div><iframe id="media-preview" name="media" src="${file.src}" style="height:500px;"></iframe></div>`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview",
                                    beforeClose:(action,instance,done)=>{
                                        //console.log(instance)
                                        done()
                                    }
                                });
                            }else if(file.typ=='contentcolumn'){//((file||{}).oname||'').match('(.pdf$)')
                                this.$alert(`<div style="display:flex;flex-direction:column;"><div style="display: flex;flex-direction: row;align-items: center;font-size: 1rem;justify-content: space-evenly;height:1rem;"><span>${file.visible_filename}</span><a href="${file.src}"><div id="qrcode"></div></a></div><iframe id="media-preview" name="media" src="${file.src}" style="height:500px;"></iframe></div>`, {
                                    dangerouslyUseHTMLString: true,
                                    customClass:"image-preview",
                                    beforeClose:(action,instance,done)=>{
                                        //console.log(instance)
                                        done()
                                    }
                                });
                            }
                            this.$nextTick(() => {
                                qrcode = document.getElementById("qrcode")
                                if(qrcode){
                                    document.getElementById("qrcode").innerHTML = ''
                                    new QRCode(document.getElementById("qrcode"), file.url);  // 设置要生成二维码的链接
                                }
                            })

                            return false
                        },
                        parsePercentage(val) {
                            return parseInt(val, 10);
                        },
                        S4() {
                            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
                        },
                        guid() {
                            return (this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4());
                        },
                        uploadMulitipart(param,callopt){
                            // let client = new OSS({
                            //     // region以杭州为例（oss-cn-hangzhou），其他region按实际情况填写。
                            //     region: 'oss-cn-beijing.aliyuncs.com',
                            //     // 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录RAM控制台创建RAM账号。
                            //     accessKeyId: 'LTAI4Fd1JMHM3WSUN4vrHcj8',
                            //     accessKeySecret: 'pXfMGYs2xAjjWHSKVoIaDuAC5ze49I',
                            //     bucket: 'bicf-media-source'
                            // });         

                            let ossConfig = {
                                // region以杭州为例（oss-cn-hangzhou），其他region按实际情况填写。
                                region: 'oss-cn-beijing',
                                // 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录RAM控制台创建RAM账号。
                                accessKeyId: 'LTAI4Fd1JMHM3WSUN4vrHcj8',
                                accessKeySecret: 'pXfMGYs2xAjjWHSKVoIaDuAC5ze49I',
                                bucket: 'bicf-media-source'
                            }

                            let client = new OSS(ossConfig);

                            let tempCheckpoint;
                            thisVue = this
                            // 定义上传方法。
                            async function multipartUpload (param,callopt) {
                                try {
                                    // object-key可以自定义为文件名（例如file.txt）或目录（例如abc/test/file.txt）的形式，实现将文件上传至当前Bucket或Bucket下的指定目录。
                                    let result = await client.multipartUpload(callopt.key, param.file, { 
                                        progress: function (p, checkpoint) {
                                            // 断点记录点。浏览器重启后无法直接继续上传，您需要手动触发上传操作。
                                            percent = p*100
                                            param.onProgress({percent:percent})
                                            console.log(p)
                                            // console.log(checkpoint)
                                            tempCheckpoint = checkpoint;
                                        },
                                        meta: { year: 2020, people: 'test' },
                                        mime: '*',
                                        callback: {
                                            url: JSON.parse(atob(callopt.callback)).callbackUrl,
                                            host: 'oss-cn-beijing.aliyuncs.com',
                                            /* eslint no-template-curly-in-string: [0] */
                                            body: 'bucket=${bucket}&object=${object}&filename=${object}&size=${size}&mimeType=${mimeType}&height=${imageInfo.height}&width=${imageInfo.width}&originname=${x:originname}&dest=${x:dest}&seriesrespath=${x:seriesrespath}&church=${x:church}',
                                            // "filename=${object}&size=${size}&mimeType=${mimeType}&height=${imageInfo.height}&width=${imageInfo.width}&originname=${x:originname}&dest=${x:dest}&seriesrespath=${x:seriesrespath}&church=${x:church}"
                                            contentType: 'application/x-www-form-urlencoded',
                                            customValue: {
                                                originname: callopt.originname,
                                                dest: callopt.dest,
                                                seriesrespath: callopt.seriesrespath,
                                                church: callopt.church,
                                            },
                                        },
                                    })
                                } catch(e){
                                    console.log(e);
                                }
                            }

                            // 开始分片上传。
                            multipartUpload(param,callopt);

                            // 暂停分片上传。
                            // client.cancel();

                            // 恢复上传。
                            // let resumeclient = new OSS(ossConfig);
                            // async function resumeUpload () {
                            // try {
                            //     let result = await resumeclient.multipartUpload('object-key', 'file-object', {
                            //     progress: function (p, checkpoint) {
                            //         tempCheckpoint = checkpoint;
                            //         },
                            //         checkpoint: tempCheckpoint,
                            //         meta: { year: 2020, people: 'test' },
                            //         mime: 'image/jpeg'
                            // })
                            // } catch (e) {
                            //     console.log(e);
                            // }
                            // }

                            // resumeUpload();
                        },
                        diyUpload(params) {
                            const thefile = params.file,
                                fileType = thefile.type,
                                isImage = fileType.indexOf("image") != -1,
                                isLt2M = thefile.size / 1024 / 1024 < 2;
                            
                            
                            console.log('-----------diyUpload------------')
                            console.log(fileType)
                            
                            thedest = this.getTyp(fileType,params.file.name)
                            thehost = `https://${this.ALIOSS_DESTINATIONS[thedest=='videos'?`${thedest}.source`:thedest]['bucket']}.${this.ALIOSS_DESTINATIONS[thedest=='videos'?`${thedest}.source`:thedest]['endpoint.acc']}`

                            console.log(`dest:${thedest};host:${thehost}`)
                            
                            tokenParams ={'type':thedest,'object_prefix':`${this.church}${(this.curdir||''=='')?'':'/'+this.curdir+'/'}`}
                            thisV = this
                            
                            store.dispatch('getOssToken',tokenParams).then((res)=>{
                                console.log('---------getOssToken----------')
                                console.log(res)

                                let fd = new FormData()
                                fd.append('OSSAccessKeyId', res.data.token['accessid'])
                                fd.append('policy', res.data.token['policy'])
                                fd.append('Signature', res.data.token['signature'])
                                fd.append('callback', res.data.token['callback'])
                                fd.append('key', `${thisV.church}/${thisV.curdir}/${thisV.guid()}`)//这个是oss中的key,随机 不用这个前缀方式了L3${(this.curdir||'').length>1?'/'+this.curdir:''}/
                                fd.append('x:originname', thefile.name)//文件原有名称 x是自定义oss回调变量
                                fd.append('x:dest', `${thedest}`)//所属的文件目标桶类型
                                fd.append('x:seriesrespath', `${ thisV.curdir }`)
                                fd.append('x:church', `${ thisV.church }`)
                                fd.append('file', thefile)
                                option = {
                                    'host':thehost,
                                    'form':fd,
                                    'uploader':params
                                }

                                if(thefile.size / 1024 / 1024  >= 5) {
                                    callopt = {
                                        'callback':res.data.token['callback'],
                                        'key':`${thisV.church}/${thisV.curdir}/${thisV.guid()}`,//这个是oss中的key,随机 不用这个前缀方式了L3${(this.curdir||'').length>1?'/'+this.curdir:''}/
                                        'originname':thefile.name,//文件原有名称 x是自定义oss回调变量
                                        'dest':`${thedest}`,//所属的文件目标桶类型
                                        'seriesrespath':`${ thisV.curdir }`,
                                        'church':`${ thisV.church }`
                                    }
                                    thisV.uploadMulitipart(params,callopt) 
                                }else{
                                    thisV.$store.dispatch('upload2oss',option)  
                                }
                            })
                        } 
                    },
                    delimiters: ["[[","]]"],
                    template:``
                });
                window.app = app
            }
        </script>
 
    </body>
</html>
