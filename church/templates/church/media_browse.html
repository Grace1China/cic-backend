{% load static i18n %}
{% load cust_filters %}
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <title>CKEditor | {% trans "Select an image to embed" %}</title>
        <link rel="stylesheet" href="{% static "church/css/dialog.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "admin/simpleui-x/elementui/theme-chalk/index.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "church/css/ossstyle.css" %}" type="text/css" />
        <!-- We only want the thunbnails to display when javascript is disabled -->
        <script type="text/javascript">
            document.write('<style>.noscript { display: none; }</style>');
        </script>
        <style type="text/css">
            a.thumb { text-align: center; display: block; float: left; width: 75px; height: 75px; word-wrap: break-word; line-height: 1.2em; overflow: hidden; }
            a.thumb img { display: inline-block; }
            span.filename { color: #666; font-size: 0.95em; }

            #page{
                height:100%;
            }
            #gallery { min-width: 880px; }
            #search {
                display:flex;
                
            }
            .image_check{
                width: 100%;
            }
            .mediacard{
                width:128px;
                min-width:128px;
            }


            .thumbimg {
                width: 100%;
                height: 100px;
                display: block;
            }
            .el-checkbox.is-bordered{
                height:auto;
                padding:0;
            }
            .el-checkbox__inner{
                position:absolute;
                left: -5px;
                bottom: 0px;
            }
            .el-checkbox__label{
                padding:0;
            }
            .imagetitle{
                width:128px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                margin-top:10px;
                position: absolute;
                bottom: 0;
                left: 0;
            }
            .toolbar {
                display: inline-flex;
                width: 100%;
                justify-content: space-between;
                margin: 15 0 0;
            }
            .el-icon-upload{
                line-height:unset;
            }
            .upload{
                height:94%;
                position:relative;
            }
            .el-upload--picture-card{
                display: inline-flex;
                justify-content: center;
                width:100%;
                height:100%;
                position:absolute;
                left:0;
            }
            .el-upload-list{
                z-index:40;
                position:absolute;
                left:0;
                width:100%;
            }
            .el-upload-dragger{
                margin: auto;
                display: flex;
                justify-content: center;
                align-items: center;
                background: none;
                border: none;
            }
            .extra-bar{
                position: absolute;
                width: 100%;
                height: 100%;
                left: 0;
                top: 0;
                cursor: default;
                text-align: center;
                color: #fff;
                opacity: 0;
                font-size: 20px;
                background-color: rgba(0,0,0,.5);
                transition: opacity .3s;
            }
            .hover .extra-bar{
                opacity: 1;
            }
            .el-checkbox__inner{
                left:0 !important;
            }
            .cktitle span{
                line-height : 1em;
            }

            .image-preview{
                width:600px !important;
                max-height:560px;
                overflow-y: scroll;
            }
            .el-tabs--border-card{
                border:none;
            }
            .el-tabs--border-card>.el-tabs__header {
                border:none;
            }
            .el-upload .el-upload--picture-card{
            
            }
            
        </style>
    </head>
    <body>
        <el-container id="page">
            <el-header>
                <div class="toolbar">
                    <el-select 
                        v-model="curdir" 
                        filterable placeholder="请选择专栏系列"
                        @change="onSeriesChange($event)"
                    >
                        {% for key,value in series.items %}
                            <el-option
                                key="{{ key }}"
                                label="{{ value }}-{{key}}"
                                value="{{ key }}">
                            </el-option>
                        {% endfor %}
                    </el-select>
                
                    <el-input placeholder="请输入查找内容" v-model="searchkey" :style="{width: '30%'}" class="input-with-select" @keyup.enter.native="showFiles(activeTab,curdir,1,{'search':searchkey})">
                        <el-button slot="append" icon="el-icon-search" @click="showFiles(activeTab,curdir,1,{'search':searchkey})"></el-button>
                    </el-input>
                   
                    <el-button-group>
                        <el-pagination
                            background
                            layout="prev, pager, next"
                            :page-size="18"	
                            :total="totalmedia"
                            @current-change="pageChange"
                        >
                        </el-pagination>
                    </el-button-group>
                    <el-button v-if="!filePrepared"  type="primary" @click="goTab('upload')"><i class="el-icon-upload"></i>去上传页</el-button>
                    <el-button v-if="filePrepared"  type="success" @click.stop.prevent="submitUpload"><i class="el-icon-upload"></i>
                                执行上传
                    </el-button>
                </div>
            </el-header>
            <el-main id="gallery">
                <el-tabs v-model="activeTab" :tab-position="'left'" v-loading="loading" type="border-card" @tab-click="handleClick">
                    <el-tab-pane v-if="isShow('images')" label="图片" name="images">
                        <el-checkbox-group  v-if="activeTab == 'images'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg  mediadata"
                                                typ='images'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview({'oname':theImage(ii,jj).visible_filename,'url':theImage(ii,jj).src,'qrcode':theImage(ii,jj).src_qrcode})"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('videos')" label="影片" name="videos">
                        <el-checkbox-group v-if="activeTab == 'videos'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div :span="4" v-for="jj in 6" :key="jj">
                                    <el-card :body-style="{ padding: '0px' , position: 'relative' , width: '100%'}"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            v-loading="theImage(ii,jj).video_status!=3"
                                            :label=`${ii}-${jj}`
                                        >
                                            <div class="thumbimg"
                                            >
                                                <img 
                                                    :src=`${theImage(ii,jj).video_status==3?(theImage(ii,jj).video_tcinfo||{}).image3+'?x-oss-process=style/wh124':theImage(ii,jj).thumb}` 
                                                    :data-src=`${theImage(ii,jj).video_status==3?(theImage(ii,jj).video_tcinfo||{}).sd:theImage(ii,jj).src}`
                                                    typ="videos"
                                                    class="mediadata"
                                                />
                                            </div>
                                            
                                            <hovercard>
                                                <!-- 1、上传成功 状态为1。后显示一个cover就好。 -->
                                                <!-- 2、转码开始 状态为2。并且有转码中。。。的提示 -->
                                                <!-- 2、转码开始 状态为3。显示一个比较好图 -->
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview({'oname':theImage(ii,jj).visible_filename,'url':(theImage(ii,jj).video_tcinfo||{}).sd,'qrcode':theImage(ii,jj).src_qrcode})"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                        <span
                                            :style="{ 'fontSize':'0.75rem' }"
                                            :title="[[ theImage(ii,jj).visible_filename  ]]"
                                        >
                                            [[ theImage(ii,jj).visible_filename | shortname]]
                                        </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('audios')" label="音乐" name="audios">
                        <el-checkbox-group v-if="activeTab == 'audios'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='audios'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview({'oname':theImage(ii,jj).visible_filename,'url':theImage(ii,jj).src,'qrcode':theImage(ii,jj).src_qrcode})"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane v-if="isShow('pdfs')" label="文档" name="pdfs">
                        <el-checkbox-group  v-if="activeTab == 'pdfs'" v-model="checkedImages" >
                            <div v-for="ii in Math.ceil(images.length/6)" :key="ii"
                                :style="{ display: 'flex'}"
                            >
                                <div  v-for="jj in 6" :key="jj"
                                >
                                    <el-card :body-style="{ padding: '0px' ,border: '0', position: 'relative', minWidth: '128px' }"
                                        v-if=" (theImage(ii,jj).src||'') != '' "
                                        class='mediacard'
                                    >
                                        <el-checkbox 
                                            border
                                            :style="{ width: '100%'}"
                                            :label=`${ii}-${jj}`
                                        >
                                            <!--上面这个label是el-checkbox-group的v-model的值。它也是唯一的。可以用来反查images里的object-->

                                            <img 
                                                :src=`${theImage(ii,jj).thumb}` 
                                                :data-src=`${theImage(ii,jj).src}` class="thumbimg mediadata"
                                                typ='pdfs'
                                                :style="{ width: '100%'}"
                                            />
                                            <hovercard>
                                                <div class='extra-bar'>
                                                    <span
                                                        @click.stop.prevent="handlePictureCardPreview({'oname':theImage(ii,jj).visible_filename,'url':theImage(ii,jj).src,'qrcode':theImage(ii,jj).src_qrcode})"
                                                    >
                                                        <i class="el-icon-zoom-in"></i>
                                                    </span>
                                                    <span
                                                        @click="removeKey(theImage(ii,jj).key)"
                                                    >
                                                        <i class="el-icon-delete"></i>
                                                    </span>
                                                </div>
                                            </hovercard>
                                        </el-checkbox>
                                            <span
                                                :style="{ 'fontSize':'1rem' }" 
                                                :title="[[ theImage(ii,jj).visible_filename  ]]"
                                            >
                                                [[ theImage(ii,jj).visible_filename | shortname ]]
                                            </span>
                                    </el-card>
                                </div>
                            </div>
                        </el-checkbox-group>
                    </el-tab-pane>
                    <el-tab-pane label="上传" name="upload">
                        <el-upload
                            class="upload"
                            ref="upload"
                            :with-credentials="true"
                            action=""
                            list-type="picture-card"
                            :auto-upload='false'
                            :before-upload="onbeforeUpload"
                            :on-progress="onprogress"
                            :on-change="onchange"
                            :on-error="onerror"
                            :on-success="onsuccess"
                            :on-remove="onremove"
                            :on-preview="handlePictureCardPreview"
                            :on-exceed="onexceed"
                            :show-file-list="true"
                            :http-request="diyUpload"
                            :limit="10"
                            multiple
                            drag
                            >
                            
                            <i class="el-icon-upload"></i>
                            
                        </el-upload> 
                        

                        {% comment %} <el-dialog :visible.sync="dialogVisible" size="tiny">
                            <img width="100%" :src="dialogImageUrl" alt="">
                        </el-dialog> {% endcomment %}
                        
                        <el-alert 
                            :title="errorMsg"
                            type="error"
                            :closable="false"
                            :style="{ display: errorDisplay }"
                        >
                        </el-alert>
                        
                    </el-tab-pane>
                </el-tabs>
                <el-dialog :visible.sync="dialogVisible" size="tiny" id="preview_dlg" @close="(this.document.querySelector('#preview_dlg video')|| this.document.createElement('video')).pause()">
                    <video v-if="dialogImageUrl.match('(.mp4$)')" :src="dialogImageUrl" controls width="100%">
                    <img v-if="dialogImageUrl.match('(.jpg$)|(.png$)|(.gif$)|(.ico$)')" width="100%" :src="dialogImageUrl" alt="">
                    <span></span>
                </el-dialog>
                
            </el-main>
            <el-footer>
                <el-button type="primary" onclick='window.close'>取消</el-button><el-button type="primary" @click=mediaReturn('ok')>确定返回结果</el-button>
            </el-footer>
        </el-container>

        <script type="text/javascript" src="{% static "church/js/vue.js" %}"></script>
        <script type="text/javascript" src="{% static "admin/simpleui-x/elementui/index.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/es6-promise.auto.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/vuex.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/store.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/axios.min.js" %}"></script>
        <script type="text/javascript" src="{% static "church/js/qrcode.min.js" %}"></script>

        <script>
            Vue.config.delimiters = ["[[", "]]"];
            Vue.component('hovercard', {
                //props: ['value'],
               
                data: function () {
                    return {
                        hover: false,
                    }
                },
                template: `
                    <div
                        @mouseover="hover = true"
                        @mouseleave="hover = false"
                        :class="{hover:hover}"
                        :style="{width: '100%', minWidth: '124px'}"
                    >
                        <slot/>
                    </div>
                `
            })

            Vue.component('hoveralter', {
                //props: ['value'],
               
                data: function () {
                    return {
                        hover1: false,
                    }
                },
                template: `
                    <div
                        @mouseover="hover1 = true"
                        @mouseleave="hover1 = false"
                        :style="{width: '100%', minWidth: '124px'}"
                    >
                        <div v-show="hover1" style="">
                            <slot name="full"></slot>
                        </div>
                        <div v-show="!hover1">
                            <slot></slot>
                        </div>
                    </div>
                `
            })
            var app = new Vue({
                el: '#page',
                data () {
                    return {
                        church:'{{ churchcode }}',
                        curdir: 'default',
                        activeTab: '{{ type }}',
                        dialogImageUrl: '',
                        dialogVisible: false,
                        errorDisplay:'none',
                        errorMsg:'',
                        filePrepared:false,
                        progressPercent:0,
                        fileArr:[],
                        page:{
                            'images':1,
                            'videos':1,
                            'audios':1,
                            'pdfs':1
                        },
                        loading:false,
                        ALIOSS_DESTINATIONS:JSON.parse(`{{ ALIOSS_DESTINATIONS|safe }}`),
                        checkedImages:[],
                        checkedImages1:[],
                        searchkey:''

                    }
                },
                computed: {
                    count() {
                        return store.state.count
                    },
                    images(){
                        return store.state.images||[]
                    },
                    totalmedia(){
                        return store.state.totalmedia||0
                    },
                },
                store,
                created:function(){
                    typ = this.getQueryVariable('type')
                    this.showFiles(typ,this.curdir,1)
                },
                mounted: function (){
                    //this.showImages(this.curdir)
                    
                },
                filters: {
                    shortname: function (value) {
                        if (!value) return ''
                        value = value.toString()
                        fn_arr = value.split('.')   //["", "mp4"]
                        
                        return (fn_arr[0].length > 10) ? `${fn_arr[0].substring(0,10)}...${fn_arr[1]}` : value
                    }
                },
                methods:{
                    checkij(value,ev){
                        console.log(`${value}-${ev}`)
                    },
                    mediaReturn(o){
                        console.log('-----mediaReturn-----------')
                        console.log(this.images)
                        arr = this.checkedImages[0].split('-')
                        index = parseInt((arr[0]-1))*6+parseInt(arr[1]-1)
                        from = this.getQueryVariable('from')
                        o = this.images[index]
                        window.opener.window.formVue.setRo({ "from":`${from}`, "obj":o } )
                        window.close()
                    },
                    getQueryVariable(variable){
                        var query = window.location.search.substring(1);
                        var vars = query.split("&");
                        for (var i=0;i<vars.length;i++) {
                                var pair = vars[i].split("=");
                                if(pair[0] == variable){return pair[1];}
                        }
                        return(false);
                    },
                   
                    isShow:function(typ='images'){
                        if (this.getQueryVariable('from')=='ckeditor' || this.getQueryVariable('from')=='admin' ){
                            return true
                        }else{
                            return this.getQueryVariable('type') == typ
                        }

                    },                    
                    theImage(i,j){
                        return (store.state.images||[])[(i-1)*6 + j-1]||{}
                    },
                    pageChange:function(page){
                        console.log(`--------pageChange(${page})----------------`)
                        this.showFiles(this.activeTab,this.curdir,page,{'search':this.searchkey})
                    },
                    next:function(){
                        //当没有18个图片的时候，说明就结束了
                        console.log('------next------')
                        this.page[this.activeTab] = (++this.page[this.activeTab] >=1 ? this.page[this.activeTab] : 1)
                        this.showFiles(this.activeTab,this.curdir,this.page[this.activeTab])
                    },
                    prev:function(){
                        this.page[this.activeTab] = (--this.page[this.activeTab] >=1 ? this.page[this.activeTab] : 1)
                        this.showFiles(this.activeTab,this.curdir,this.page[this.activeTab])
                    },
                    goTab(page){
                        this.activeTab = page
                    },
                    onSeriesChange:function(sereis){
                        if (sereis == 'upload') {return}
                        this.showFiles(this.activeTab,sereis,this.page[this.activeTab])
                    },
                    showFiles:function(type,series,page,extra){
                        /*
                        page 是从1开始的。有delfilekey，删除的文件key,在删除后，从新查找的逻辑
                        */
                        //delfilekey=undefined,searchkey=undefined
                        extra = extra||{}
                        vm = this
                        vm.loading = true
                        store.dispatch('getImages',{'type':type,'series':series,'page':page,'delfilekey':extra.delete,'searchkey':extra.search}).then(function(){
                            vm.$forceUpdate()
                            vm.loading = false
                        })
                    },
                    handleClick(tab, event) {
                        console.log(tab, event)
                        console.log(`-----------this.activeTab -------${this.activeTab}----`)
                   
                        this.loading = true
                        this.activeTab = tab.name
                        this.showFiles(tab.name,this.curdir,this.page.image)
                        this.checkedImages = []
                    },
                    onbeforeUpload(file){
                        console.log('--------onbeforeUpload----------')
                        console.log(file)
                    },
                    onprogress(e, rawFile,fileList){
              
                        this.fileArr = fileList
                        this.fileArr.forEach(item=>{
                            if (item.percentage == 100) {

                            } else {
                                item.progressFlag = true
                                item.progressPercent = Math.abs(item.percentage.toFixed(0));
                            }
                        })
                    },
                    getTyp(filetype){
                        if(filetype.match('image/')){
                            return 'images'
                            
                        }
                        if(filetype.match('video/')){
                            return 'videos'
                        }
                        if(filetype.match('audio/')){
                            return 'audios'
                        }
                        if(filetype.match('pdf/')){
                            return 'pdfs'
                        }
                        return 'destination'
                    },
                    onchange(e,fileList){
                        console.log('-------onchange---------')
                        console.log(e)
                        console.log(fileList)

                        this.errorDisplay = 'none'
                        this.errorMsg=''

                        if(!e.raw.type.match('image/')){
                            if(e.raw.type.match('video/')){
                                e.url="/static/church/img/vidoe.jpg"
                            } else if(e.raw.type.match('audio/')){
                                e.url="/static/church/img/audio.jpg"
                            } else{
                                e.url="/static/church/img/document.jpg"   
                            }
                        }
                        this.filePrepared = false
                        
                        fileList.forEach((item,index)=>{
                            allOk = true
                            if(item.status != 'ready'){
                                allOk = false
                            }
                            this.filePrepared = allOk
                        })
                        if (fileList.length <= 0){
                            this.filePrepared = false
                        }
                        //"success" "ready" "uploading" "fail"
                    },
                    onerror(e,f){
                        console.log('-------onerror---------')
                        console.log(e)
                        console.log(f)
                    },
                    onsuccess(e,f,fileList){
                        console.log('-------onsuccess---------')
                        console.log(e)
                        console.log(f)
                        this.fileArr = fileList
                        this.fileArr.forEach((item,index)=>{
                            item.progressFlag = false
                            if(item.status == 'success'){
                                item.successFlag = true
                            }else{
                                item.successFlag = false
                            }
                        })
                    },
                    onremove(e,f){
                        console.log('-------onremove---------')
                        console.log(e)
                        console.log(f)
                        
                        if (f.length <= 0){
                            this.filePrepared = false
                        }
                        //this.fileArr.splice(f,1)
                    },
                    removeFile(item,index){
                        this.fileArr.splice(f,index)
                    },
                    onpreview(e,f){
                        console.log('-------onpreview---------')
                        console.log(e)
                        console.log(f)
                    },
                    onexceed(e,f){
                        console.log('-------onexceed---------')
                        console.log(e)
                        console.log(f)
                        if((e||[]).length >10){
                            this.errorDisplay = 'block'
                            this.errorMsg = `最多只能一次加入10个文件，现在有${e.length}请重新选择。`
                        }else{
                            this.errorDisplay = 'none'
                            this.errorMsg=''
                        }
                    },
                    submitUpload() {
                        //console.log(file)
                        
                        //return true
                        console.log('--------submitUpload---------------')
                        this.$refs.upload.submit();
                    },
                    removeKey(key){
                        console.log(`-----need to delete the bucket file and db record---of--${key}--`)
                        this.showFiles(this.activeTab,this.curdir,1,{'delete':key})
                    },
                    handlePictureCardPreview(file) {
                        console.log('------------handlePictureCardPreview---------------')
                        console.log(file)
                        
                        if (((file||{}).oname||'').match('(.jpg$)|(.png$)|(.gif$)|(.ico$)')){
                            this.$alert(`<span>${file.oname}</span><img style="width:100%;height:auto;" src="${file.url}">`, {
                                dangerouslyUseHTMLString: true,
                                customClass:"image-preview"
                            });
                            return
                        } else if (((file||{}).oname||'').match('(.mp4$)')){
                            this.$alert(`<span>${file.oname}</span><video id="media-preview" style="width:100%;height:auto;" controls src="${file.url}">`, {
                                dangerouslyUseHTMLString: true,
                                customClass:"image-preview",
                                beforeClose:(action,instance,done)=>{
                                    //console.log(instance)
                                    (instance.$el.querySelector('video#media-preview')||this.document.createElement('video')).pause()
                                    done()
                                }
                            });
                            return
                        }else if(((file||{}).oname||'').match('(.mp3$)|(.wav$)')){
                            this.$alert(`<div style="display:flex;flex-direction:column;"><span>${file.oname}</span><video controls="" autoplay="" id="media-preview" name="media"><source src="${file.url}" type="audio/mpeg"></video></div>`, {
                                dangerouslyUseHTMLString: true,
                                customClass:"image-preview",
                                beforeClose:(action,instance,done)=>{
                                    //console.log(instance)
                                    (instance.$el.querySelector('video#media-preview')||this.document.createElement('audio')).pause()
                                    done()
                                }
                            });
                        }else if(((file||{}).oname||'').match('(.pdf$)')){
                            this.$alert(`<div style="display:flex;flex-direction:column;"><span>${file.oname}</span><div id="qrcode"></div><iframe id="media-preview" name="media" src="${file.url}" ></iframe></div>`, {
                                dangerouslyUseHTMLString: true,
                                customClass:"image-preview",
                                beforeClose:(action,instance,done)=>{
                                    //console.log(instance)
                                    done()
                                }
                            });

                            
                        }
                        this.$nextTick(() => {
                            new QRCode(document.getElementById("qrcode"), file.url);  // 设置要生成二维码的链接
                        })

                        return false
                    },
                    parsePercentage(val) {
                        return parseInt(val, 10);
                    },
                    S4() {
                        return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
                    },
                    guid() {
                        return (this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4());
                    },
                    diyUpload(params) {
                        const thefile = params.file,
                            fileType = thefile.type,
                            isImage = fileType.indexOf("image") != -1,
                            isLt2M = thefile.size / 1024 / 1024 < 2;
                        console.log('-----------diyUpload------------')
                        console.log(fileType)
                        thedest = this.getTyp(fileType)
                        thehost = `https://${this.ALIOSS_DESTINATIONS[thedest=='videos'?`${thedest}.source`:thedest]['bucket']}.${this.ALIOSS_DESTINATIONS[thedest=='videos'?`${thedest}.source`:thedest]['endpoint.acc']}`

                        console.log(`dest:${thedest};host:${thehost}`)
                        
                        tokenParams ={'type':thedest,'object_prefix':`${this.church}${(this.curdir||''=='')?'':'/'+this.curdir+'/'}`}
                        thisV = this
                        store.dispatch('getOssToken',tokenParams).then((res)=>{
                            console.log('---------getOssToken----------')
                            console.log(res)

                            let fd = new FormData()
                            fd.append('OSSAccessKeyId', res.data.token['accessid'])
                            fd.append('policy', res.data.token['policy'])
                            fd.append('Signature', res.data.token['signature'])
                            fd.append('callback', res.data.token['callback'])
                            fd.append('key', `${thisV.church}/${thisV.curdir}/${thisV.guid()}`)//这个是oss中的key,随机 不用这个前缀方式了L3${(this.curdir||'').length>1?'/'+this.curdir:''}/
                            fd.append('x:originname', thefile.name)//文件原有名称 x是自定义oss回调变量
                            fd.append('x:dest', `${thedest}`)//所属的文件目标桶类型
                            fd.append('x:seriesrespath', `${ thisV.curdir }`)
                            fd.append('x:church', `${ thisV.church }`)
                            fd.append('file', thefile)
                            option = {
                                'host':thehost,
                                'form':fd,
                                'uploader':params
                            }
                            thisV.$store.dispatch('upload2oss',option)
                        })
                    } 
                },
                delimiters: ["[[","]]"]
            });
        </script>
 
    </body>
</html>
